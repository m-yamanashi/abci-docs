# ジョブ実行

## ジョブサービス {#job-services}

ABCIシステムでは、以下のジョブサービスが利用可能です。

| サービス名 | 説明 | サービス課金係数 | 利用形態 |
|:--|:--|:--|:--|
| On-demand | インタラクティブジョブの実行サービス | 7.5 | インタラクティブジョブ |
| Spot | バッチジョブの実行サービス | 7.5 | バッチジョブ |
| Reserved | 事前予約型ジョブサービス | 11.25 | 事前予約 |

各ジョブサービスで利用可能なジョブ実行リソース、制限事項等については、[ジョブ実行リソース](#job-execution-resource)を参照してください。また、課金については、[課金](#accounting)を参照してください。

### On-demandサービス {#on-demand-service}

プログラムのコンパイルやデバッグ、対話的なアプリケーション、可視化ソフトウェアの実行に適したインタラクティブジョブの実行サービスです。

利用方法は[インタラクティブジョブ](#interactive-jobs)、インタラクティブジョブの実行オプションの詳細は[ジョブ実行オプション](#job-execution-options)をそれぞれ参照してください。

### Spotサービス {#spot-service}

対話的な処理の必要がないアプリケーションの実行に適したバッチジョブの実行サービスです。On-demandサービスに比べてより長時間のジョブや、より並列度の高いジョブの実行が可能です。

利用方法は[バッチジョブ](#batch-jobs)、バッチジョブの実行オプションの詳細は[ジョブ実行オプション](#job-execution-options)をそれぞれ参照してください。

### Reservedサービス {#reserved-service}

計算リソースを日単位で事前に予約して利用できるサービスです。On-demandおよびSpotサービスの混雑の影響を受けることなく、計画的なジョブ実行が可能となります。また、Spotサービスの経過時間制限以上の予約日数が取れるため、より長時間のジョブ実行が可能です。

Reservedサービスでは、まず事前予約を行って予約ID (AR-ID)を取得し、この予約IDを用いてインタラクティブジョブやバッチジョブの実行を行います。

予約方法は[事前予約](#advance-reservation)を参照してください。インタラクティブジョブやバッチジョブの利用方法、実行オプションはOn-demandおよびSpotサービスと共通です。

## ジョブ実行リソース {#job-execution-resource}

ABCIシステムでは、計算リソースを論理的に分割した資源タイプを利用して、ジョブサービスにシステムリソースを割り当てます。On-demand、Spot、Reservedのいずれのサービスを利用する場合も、利用者は利用したい資源タイプとその数量を指定して、ジョブの投入/実行、計算ノードの予約を行います。

以下では、まず利用可能な資源タイプについて解説し、続いて同時に利用可能な資源量、経過時間およびノード時間積、ジョブ投入数および実行数に関する制限事項等を説明します。

### 利用可能な資源タイプ {#available-resource-types}

ABCIシステムには、次の資源タイプが用意されています。



| 資源タイプ名 | 説明 | 割り当て物理CPUコア数 | 割り当てGPU数 | メモリ (GB) | ローカルストレージ (TB) | 資源タイプ課金係数 |
|:--|:--|:--|:--|:--|:--|:--|
| rt\_HF | ノード占有 | 96 | 8 | 1728 | 14 | 15 |
| rt\_HG | ノード共有<br>GPU利用 | 8 | 1 | 144 | 1.4 | 2|
| rt\_HC | ノード共有<br>CPUのみ利用 | 16 | 0 | 288 | 1.4 | 1 |


### 同時に利用可能なノード数 {#number-of-nodes-available-at-the-same-time}

ジョブサービスごとに利用可能な資源タイプとノード数の組み合わせを以下に示します。同時に複数ノードを利用する場合は、資源タイプ`rt_HF`を指定する必要があります。

| サービス名 | 資源タイプ名 | ノード数 |
|:--|:--|--:|
| Reserved  | rt\_HF       | 1-予約ノード数 |

### 経過時間およびノード時間積の制限 {#elapsed-time-and-node-time-product-limits}

ジョブサービス、資源タイプに応じて、ジョブの経過時間制限 (実行可能時間の制限) があります。上限値およびデフォルト値を以下に示します。

| サービス名 | 資源タイプ名 | 経過時間制限 (上限値/デフォルト) |
|:--|:--|:--|
| Spot      | rt\_HF, rt\_HG, rt\_HC | 168:00:00/1:00:00 |
| On-demand | rt\_HF, rt\_HG, rt\_HC | 12:00:00/1:00:00 |

また、On-demandおよびSpotサービスで、複数ノードを使用するジョブを実行する場合には、ノード時間積（使用ノード数 &times; 実行時間）に以下の制限があります。

| サービス名 | ノード時間積の最大値 |
|:--|--:|
| Spot                          | 21504 nodes &middot; hours |
| On-demand                                     |    12 nodes &middot; hours |

!!! note
    Reservedサービスでは経過時間に制限はありませんが、予約の終了と共にジョブは強制終了します。
    Reservedサービスに関する制限の詳細については[事前予約](#advance-reservation)を参照してください。

### ジョブ投入数および実行数の制限 {#limitation-on-the-number-of-job-submissions-and-executions}

1ユーザが同時に投入・実行できるジョブ数に以下の制限があります。
予約ノードに投入されたジョブもOn-demandやSpotのジョブと同様にジョブ数のカウントに含まれ、本制約を受けます。

| 制限項目 | 制限値 |
|:--|:--|
| 1ユーザあたりの同時投入可能ジョブ数 | 1000 |
| 1ユーザあたりの同時実行ジョブ数 | 200 |
| 1アレイジョブあたりの最大投入可能タスク数 | 75000 |

2023年度まで資源タイプごとのジョブ実行数に制限はなく、利用可能な計算リソースから順次割り当てていましたが、
2024年度以降、資源タイプごとにシステムあたりの同時実行ジョブ数に制限を設けます。
なお、対象となるジョブサービスはOn-demandサービスとSpotサービスとなります。
Reservedサービスで予約ノードに投入されたジョブはカウントに含まれません。

| 資源タイプ | システムあたりの同時実行ジョブ数の制限値 |
|:--|:--|
| rt_HF | 736 |
| rt_HG | 240 |
| rt_HC | 60 |

## ジョブ実行オプション {#job-execution-options}

インタラクティブジョブ、バッチジョブの実行には`qsub`コマンドを使用します。

`qsub`コマンドに関する、主要なオプションを以下に示します。

| オプション | 説明 |
|:--|:--|
| -P *group* | ABCI利用グループを*group*で指定します。自分のABCIアカウントが所属しているABCIグループのみ指定できます。本オプションは指定必須です。 |
| -q *resource_type* | 資源タイプ*resource_type*を指定します。本オプションは指定必須です。 |
| -l select=*num*:ncpus=*num_cpus* | ノード数を*num*で、資源タイプに対応したCPU数を*num_cpus*で指定します。*num_cpus*について、rt_HFは192、rt_HCは32、rt_HGは16を設定します。本オプションは指定必須です。 |
| -l walltime=[*HH:MM:*]*SS* | 経過時間制限値を指定します。[*HH:MM:*]*SS*で指定することができます。ジョブの実行時間が指定した時間を超過した場合、ジョブは強制終了されます。 |
| -N name | ジョブ名を*name*で指定します。デフォルトは、ジョブスクリプト名です。 |

## インタラクティブジョブ {#interactive-jobs}

インタラクティブジョブを実行するには、`qsub`コマンドに`-I`オプションを付け加えます。

```
$ qsub -I -P group -q resource_type -l select=num:ncpus=num_cpus [options]
```

例) インタラクティブジョブを実行 (On-demandサービス)

```
[username@int1 ~]$ qsub -I -P grpname -q rt_HF -l select=1:ncpus=192
[username@hnode001 ~]$ 
```

!!! note
    On-demandサービスでは、インタラクティブジョブ実行時にABCIポイントが不足している場合、ジョブの実行に失敗します。

## バッチジョブ {#batch-jobs}

ABCIシステムでバッチジョブを実行する場合、実行するプログラムとは別にジョブスクリプトを作成します。
ジョブスクリプトには利用する資源タイプ名、経過時間制限値などの資源などのジョブ実行オプションを記述した上で、
実行するコマンド列を記載します。

```bash
#!/bin/sh
#PBS -q rt_HF
#PBS -l select=1:ncpus=192
#PBS -l walltime=1:23:45
#PBS -P grpname

cd ${PBS_O_WORKDIR}

[Environment Modules の初期化]
[Environment Modules の設定]
[プログラムの実行]
```

例) CUDAを利用したプログラムを実行するジョブスクリプト例

```bash
#!/bin/sh
#PBS -q rt_HF
#PBS -l select=1:ncpus=192
#PBS -l walltime=1:23:45
#PBS -P grpname

cd ${PBS_O_WORKDIR}

source /etc/profile.d/modules.sh
module load cuda/12.6/12.6.1
./a.out
```

### バッチジョブの投入 {#submit-a-batch-job}

バッチジョブを実行するには、`qsub`コマンドを使用します。実行後はジョブIDが出力されます。

```
$ qsub script_name
```

例) ジョブスクリプトrun.shをバッチジョブとして投入 (Spotサービス)

```
[username@int1 ~]$ qsub run.sh
1234.pbs1
```

!!! note
    Spotサービスでは、バッチジョブ投入時にABCIポイントが不足している場合、バッチジョブの投入に失敗します。

### ジョブ投入時のエラー {#job-submission-error}

バッチジョブの投入に成功した場合、`qsub`コマンドの終了ステータスは`0`となります。
失敗した場合は0以外の値となり、エラーメッセージが出力されます。

### バッチジョブの状態の確認 {#show-the-status-of-batch-jobs}

バッチジョブを状態を確認するには、`qstat`コマンドを利用します。

```
$ qstat [options]
```

`qstat`コマンドの主要なオプションを以下に示します。

| オプション | 説明 |
|:--|:--|
| -f | ジョブに関する追加情報を表示します。 |

例)

```
[username@int1 ~]$ qstat
Job id                 Name             User              Time Use S Queue
---------------------  ---------------- ----------------  -------- - -----
12345.pbs1              run.sh           username          00:01:23 R rt_HF
```

| 項目 | 説明 |
|:--|:--|
| Job id | ジョブID |
| Name | ジョブ名 |
| User | ジョブのオーナー |
| Time Use | ジョブのCPU利用時間 |
| S | ジョブ状態 (R: 実行中, Q: 待機中, F: 完了, S: 一時停止, E: 終了中) |
| Queue | 資源タイプ |


### バッチジョブの削除 {#delete-a-batch-job}

バッチジョブを削除するには、`qdel`コマンドを利用します。

```
$ qdel job_id
```

例) バッチジョブを削除

```
[username@int1 ~]$ qstat
Job id                 Name             User              Time Use S Queue
---------------------  ---------------- ----------------  -------- - -----
12345.pbs1              run.sh           username          00:01:23 R rt_HF
[username@int1 ~]$ qdel 12345.pbs1
[username@int1 ~]$
```


### バッチジョブの標準出力と標準エラー出力 {#stdout-and-stderr-of-batch-jobs}

バッチジョブの標準出力ファイルと標準エラー出力ファイルは、ジョブ実行ディレクトリもしくは、
ジョブ投入時に指定されたファイルに出力されます。
標準出力ファイルにはジョブ実行中の標準出力、標準エラー出力ファイルにはジョブ実行中のエラーメッセージが出力されます。
ジョブ投入時に、標準出力ファイル、標準エラー出力ファイルを指定しなかった場合は、以下のファイルに出力されます。

- *JOB_NAME*.o*NUM_JOB_ID*  ---  標準出力ファイル
- *JOB_NAME*.e*NUM_JOB_ID*  ---  標準エラー出力ファイル

例）ジョブ名がrun.sh、ジョブIDが`12345.pbs1`の場合

- 標準出力ファイル名：run.sh.o12345
- 標準エラー出力ファイル名：run.sh.e12345

## 事前予約（更新中） {#advance-reservation}

Reservedサービスでは、計算ノードを事前に予約して計画的なジョブ実行が可能となります。

本サービスで予約可能なノード数およびノード時間積は、以下表の「1予約あたりの最大予約ノード数」、「1予約あたりの最大予約ノード時間積」が上限です。また、本サービスでは、利用者は予約ノード数を上限とするジョブしか実行できません。なお、システム全体で「システムあたりの最大同時予約可能ノード数」に上限があるため、「1予約あたりの最大予約ノード数」を下回る予約しかできない場合や、予約自体ができない場合があります。予約した計算ノードにて[各資源タイプ](#available-resource-types)が利用可能です。

| 項目 | 設定値 |
|:--|:--|
| 最小予約日数 | 1日 |
| 最大予約日数 | 60日 |
| ABCIグループあたりの最大同時予約可能ノード数 | 192ノード |
| システムあたりの最大同時予約可能ノード数 | 384ノード |
| 1予約あたりの最小予約ノード数 | 1ノード |
| 1予約あたりの最大予約ノード数 | 192ノード |
| 1予約あたりの最大予約ノード時間積 | 64,512ノード時間積 |

### 予約の実行 {#make-a-reservation}

計算ノードを予約するには、`qrsub`コマンドを使用します。
予約が完了すると、予約IDが発行されますので、予約した計算ノードを使用する際にこの予約IDを指定してください。

!!! warning
    計算ノードの予約は、利用責任者もしくは利用管理者のみが実施できます。

```
$ qrsub options
```

| オプション | 説明 |
|:--|:--|
| -a *YYYYMMDD* | 予約開始日を*YYYYMMDD*で指定します。 |
| -d *days* | 予約日数を*days*で指定します。 -eオプションとは排他です。 |
| -e *YYYYMMDD* | 予約終了日を*YYYYMMDD*指定します。-dオプションとは排他です。 |
| -g *group* | ABCI利用グループを*group*で指定します。 |
| -N *name* | 予約名を*name*で指定します。英数字と記号`=+-_.`が指定可能で、最大64文字まで指定できます。ただし、先頭の文字に数字を指定することはできません。 |
| -n *nnnode* | 予約するノード数を*nnnode*で指定します。 |
| -l *resource_type* | 予約する資源タイプを*resource_type*で指定します。 省略した場合は、rt_F が指定されたとみなします。|

例) 2024年7月5日から1週間 (7日間) 計算ノード4台を予約

```
[username@int1 ~]$ qrsub -a 20240705 -d 7 -P grpname -n 4 -N "Reserve_for_AI"
Your advance reservation 12345 has been granted
```


計算ノードの予約が完了した時点でABCIポイントを消費します。
また、発行された予約IDは予約時に指定したABCIグループに所属するABCIアカウントでご利用いただけます。

!!! note
    予約可能なノード数が`qrsub`コマンドで指定したノード数より少ない場合、以下のエラーメッセージを出力して予約取得に失敗します。  
    ```
    advance_reservation: no suitable queues
    ```  
    なお、`qrstat --available` コマンドで表示されるノード数には、現在実行中のジョブは加味されておりません。そのため、qrstat コマンドで「予約可能なノード数」が表示されていても、予約に失敗することがあります。

### 予約状態の確認 {#show-the-status-of-reservations}

予約状態を確認するには、`qrstat`コマンドを使用します。

例)

```
[username@int1 ~]$ qrstat
ar-id      name       owner        state start at             end at               duration    sr
----------------------------------------------------------------------------------------------------
     12345 Reserve_fo root         w     07/05/2024 10:00:00  07/12/2024 09:30:00  167:30:00    false
```

| 項目 | 説明 |
|:--|:--|
| ar-id | 予約ID (AR-ID) |
| name | 予約名 |
| owner | 常にrootと表示 |
| state | 予約状態 |
| start at | 予約開始日 (予約開始時刻は常に午前10時) |
| end at | 予約終了日 (予約終了時刻は常に午前9時30分) |
| duration | 予約期間 (hhh:mm:ss) |
| sr | 常にfalseと表示 |

システムあたりの予約可能ノード数を確認するには、`qrstat`コマンドの`--available`オプションを使用します。

計算ノードの予約可能ノード数の確認
```
[username@int1 ~]$ qrstat --available
06/27/2024  441
07/05/2024  432
07/06/2024  434
```


!!! note
    計算ノードが予約されていない日付は表示されません。

### 予約の取り消し {#cancel-a-reservation}

!!! warning
    予約の取り消しは利用責任者もしくは利用管理者のみが実施できます。

予約を取り消すには、`qrdel`コマンドを使用します。`qrdel`コマンドでの予約取り消しは、「,(カンマ)」区切りのリストとして複数指定できます。指定したar_idの中に1つでも存在しない予約ID、もしくは削除権限のない予約IDが指定されている場合は、エラーとなり削除は実行されません。

例) 予約を取り消し

```
[username@int1 ~]$ qrdel 12345,12346
```

### 予約ノードの使い方 {#how-to-use-reserved-node}

予約した計算ノードには、`-ar`オプションにて予約IDを指定してジョブを投入します。

例) 予約ID`12345`で予約された計算ノードでインタラクティブジョブを実行

```
[username@int1 ~]$ qrsh -g grpname -ar 12345 -l rt_HF=1 -l h_rt=1:00:00
[username@hnode001 ~]$ 
```

例) ジョブスクリプトrun.shを予約ID`12345`で予約された計算ノードにバッチジョブとして投入

```
[username@int1 ~]$ qsub -P grpname -ar 12345 run.sh
Your job 12345 ("run.sh") has been submitted
```

!!! note  
    - 予約作成時に指定したABCIグループを指定する必要があります。
    - バッチジョブは予約作成直後から投入できますが、予約開始時刻になるまで実行されません。  
    - 予約開始時刻前に投入したバッチジョブは`qdel`コマンドで削除できます。  
    - 予約開始時刻前に予約を削除した場合、当該予約に投入されていたバッチジョブは削除されます。  
    - 予約終了時刻になると実行中のジョブは強制終了されます。  

### 予約ノードご利用時の注意 {#cautions-for-using-reserved-node}

予約は期間中の計算ノードの可用性を保証するものではありません。予約した計算ノードの利用中に一部が利用不可となることがありますので、以下の点をご確認ください。

* 予約した計算ノードの利用可否状態は、`qrstat -ar ar_id` コマンドで確認できます。
* 予約開始前日に一部の予約ノードが利用不可と表示される場合は、予約の取り消し・再度予約をご検討ください。
* 予約期間中に計算ノードが利用不可となった場合などの時は、[お問い合わせ](./contact.md)のページをご覧の上、<qa@abci.ai> までご連絡ください。

!!! note
    - 予約の取り消しは予約開始前日の午後9時までになります。
    - 計算ノードの空きが無い場合、予約の作成はできません。
    - ハードウェア障害は適宜対応しております。予約開始前日より前の利用不可に対するお問い合わせはご遠慮願います。
    - 予約している計算ノード数変更や予約期間の延長の依頼は対応不可になります。

例) hnode001は利用可能、hnode002は利用不可
```
[username@int1 ~]$ qrsub -a 20240705 -d 7 -P grpname -n 2 -N "Reserve_for_AI" 
Your advance reservation 12345 has been granted
[username@int1 ~]$ qrstat -ar 12345
(snip)
message                             reserved queue gpu@hnode002 is disabled
message                             reserved queue gpu@hnode002 is unknown
granted_parallel_environment        perack01
granted_slots_list                  gpu@hnode001=80,gpu@hnode002=80
```

## 課金（更新中） {#accounting}

### Spotサービス {#on-demand-and-spot-services}

On-demandおよびSpotサービスでは、ジョブ実行開始時にジョブが使用予定のABCIポイントを経過時間制限値を元に計算し、減算処理を実施します。ジョブ実行終了時に実際の経過時間を元にABCIポイントを再計算し、返却処理を実施します。

サービスごとの使用ABCIポイントの計算式は以下の通りです。

> [サービス課金係数](#job-services)  
> &times; [資源タイプ課金係数](#available-resource-types)  
> &times; POSIX 優先度課金係数 (1.0 or 1.5)  
> &times; 資源タイプ個数  
> &times; max(経過時間[秒], 最低経過時間[秒])  
> &times; 利用クラス係数 （標準利用:1.0, 開発加速利用:0.5）  
> &div; 3600

!!! note
    - 小数点5位以下は切り捨てられます。
    - 最低経過時間より短い経過時間ジョブを実行した場合、ABCIポイントは最低経過時間を元に計算されます。

### Reservedサービス {#reserved-service_1}

Reservedサービスでは、予約完了時に予約期間を元にABCIポイントを計算し、減算処理を実施します。予約の取り消しをしない限り、返却処理は実施されません。予約にて消費するポイントは、グループの利用責任者の消費ポイントとしてカウントされます。

サービスごとの使用ABCIポイントの計算式は以下の通りです。

> [サービス課金係数](#job-services)  
> &times; [資源タイプ課金係数](#available-resource-types)  
> &times; 予約ノード数  
> &times; 予約日数  
> &times; 利用クラス係数 （標準利用:1.0, 開発加速利用:0.5）  
> &times; 24

!!! note
    計算ノードの予約は資源タイプrt_HFとして扱われます。
